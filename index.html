<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mind Clock</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Kaisei+Tokumin&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Yusei+Magic&display=swap');


    body {
      width: 700px;
      margin: 0 auto;
      text-align: left;
      padding: 15px;
      box-sizing: border-box;
      background-color: #000;
      color: #0f0;
      font-family: 'Orbitron', sans-serif;
      -webkit-app-region: drag;
    }
    #timerDisplay {
      font-size: 35px;
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    #timerDisplay:hover {
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
    }
    #timerDisplay.running {
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
    }
    .timer-controls {
      display: flex;
      gap: 10px;
    }
    .timer-button {
      background: none;
      border: 2px solid #0f0;
      color: #0f0;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      padding: 0;
      opacity: 0.7;
    }
    .timer-button:hover {
      opacity: 1;
      background: #0f01;
      box-shadow: 0 0 10px #0f0;
    }
    .timer-button.active {
      opacity: 1;
      background: #0f01;
      box-shadow: 0 0 10px #0f0;
    }
    button {
      font-size: 12px;
      padding: 8px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      background-color: #111;
      color: #0f0;
      box-shadow: 3px 3px 6px #050, -3px -3px 6px #0a0;
      transition: 0.2s;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      -webkit-app-region: no-drag;
    }
    button:hover {
      background-color: #0f0;
      color: #000;
      font-family: 'Orbitron', sans-serif;
    }
    button:active {
      box-shadow: 1px 1px 3px #050, -1px -1px 3px #0a0;
      font-family: 'Orbitron', sans-serif;
    }
    textarea {
      width: 100%;
      font-size: 15px;
      margin: 10px 0;
      resize: none;
      padding: 10px;
      border: 1px solid #0f0;
      border-radius: 5px;
      background-color: #000;
      color: #0f0;
      font-family: 'Kaisei Tokumin', serif;
      box-sizing: border-box;
      overflow: hidden;
      -webkit-app-region: no-drag;
    }
    textarea:focus {
      box-shadow: 0 0 20px #0f04, inset 0 0 20px #0f02;
      background-color: #0c0c0c;
    }
    textarea::placeholder {
      color: #0f0;
      opacity: 0.3;
      text-shadow: 0 0 5px #0f0;
    }
    .input-container {
      position: relative;
      margin: 20px 0;
    }
    .input-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #0f0, transparent);
    }
    .input-container::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #0f0, transparent);
    }
    #message {
      font-size: 14px;
      color: #0f0;
      margin-top: 10px;
      display: none;
      font-family: 'Orbitron', sans-serif;
    }
    h1 {
      margin-bottom: 20px;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }
    #tweets {
      text-align: left;
      margin-top: 20px;
      font-family: 'Yusei Magic', serif;
    }
    .tweet {
      font-size: 18px;
      margin-bottom: 10px;
      border-bottom: 1px solid #0f0;
      padding: 10px;
      padding-left: 15px;
      font-family: 'Yusei Magic';
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
      outline: none;
      cursor: pointer;
      border-radius: 3px;
      -webkit-app-region: no-drag;
      border-left: 5px solid transparent;
      box-sizing: border-box;
    }
    .tweet:focus {
      background: rgba(0, 255, 0, 0.05);
      box-shadow: 0 0 10px #0f03;
      border-left: 5px solid #0f0;
      padding-left: 15px;
    }
    .tweet:hover {
      background: rgba(0, 255, 0, 0.02);
    }
    .tweet .content {
      flex-grow: 1;
      margin-right: 15px;
      white-space: pre-wrap;
    }
    .tweet span.time {
      font-size: 12px;
      color: #0f0;
      opacity: 0.5;
      font-family: 'Orbitron', sans-serif;
      margin-right: 10px;
      min-width: 85px;
      text-align: right;
    }
    .tweet:hover span.time {
      opacity: 1;
    }
    /* å­ãƒ„ã‚¤ãƒ¼ãƒˆé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .tweet.child-tweet {
      margin-left: 20px;
      font-size: 16px;
      border-left: 5px solid transparent;
      border-bottom: 1px dashed #0f0;
    }
    .tweet.child-tweet:focus {
      border-left: 5px solid #0f0;
    }
    .tweet .child-indicator {
      position: absolute;
      left: -15px;
      top: 50%;
      transform: translateY(-50%);
      color: #0f0;
      font-size: 14px;
      opacity: 0.7;
    }
    .tweet .has-children-indicator {
      margin-right: 5px;
      color: #0f0;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.7;
    }
    .tweet .has-children-indicator:hover {
      opacity: 1;
    }
    .children-container {
      margin-left: 20px;
      border-left: 1px dashed #0f0;
      padding-left: 10px;
      display: none;
    }
    .children-container.expanded {
      display: block;
    }
    .tweet-actions {
      display: flex;
      gap: 5px;
      margin-right: 5px;
    }
    .tweet-action {
      color: #0f0;
      opacity: 0.5;
      cursor: pointer;
      font-size: 14px;
    }
    .tweet-action:hover {
      opacity: 1;
    }
    .controls-info {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.9);
      border: 1px solid #0f0;
      border-radius: 10px;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 0 20px #0f0;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
    }
    .controls-info:hover {
      opacity: 1;
    }
    .shortcut-group {
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .key {
      background: #0f01;
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid #0f02;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
    }
    .key-separator {
      opacity: 0.5;
    }
    .flush-btn {
      position: absolute;
      right: 15px;
      bottom: 15px;
      background-color: #111;
      color: #f00;
      border: none;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      box-shadow: 2px 2px 4px #500, -2px -2px 4px #500;
      transition: all 0.2s ease;
      border-radius: 3px;
      letter-spacing: 1px;
      opacity: 0.4;
      -webkit-app-region: no-drag;
    }
    .flush-btn:hover {
      opacity: 1;
      background-color: #200;
      color: #f00;
      box-shadow: 3px 3px 6px #500, -3px -3px 6px #500;
      text-shadow: 0 0 5px #f00;
    }
    .flush-btn:active {
      box-shadow: 1px 1px 2px #500, -1px -1px 2px #500;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      -webkit-app-region: no-drag;
    }
    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #0f0;
      box-shadow: 0 0 20px #0f04;
      z-index: 1001;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
    }
    .modal-message {
      color: #0f0;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .modal-btn {
      padding: 5px 15px;
      border: 1px solid #0f0;
      background: #111;
      color: #0f0;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
    }
    .modal-btn:hover {
      background: #0f0;
      color: #000;
    }
    .modal-btn.cancel {
      border-color: #f00;
      color: #f00;
    }
    .modal-btn.cancel:hover {
      background: #f00;
      color: #000;
    }
    @keyframes matrix-rain {
      0% {
        transform: translateY(-100%);
        opacity: 0;
      }
      50% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(100%);
        opacity: 0;
      }
    }
    .tweet.matrix-effect::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(0, 255, 0, 0.5) 0%, transparent 100%);
      animation: matrix-rain 1s linear;
      pointer-events: none;
      z-index: 1;
    }
    .tweet.editing .content {
      background: rgba(0, 255, 0, 0.05);
      padding: 5px;
      border-radius: 3px;
      outline: none;
      border-bottom: 2px solid #0f0;
      transition: all 0.2s ease;
    }
    .tweet.editing .content:focus {
      background: rgba(0, 255, 0, 0.08);
      border-bottom: 2px solid #0f0;
      box-shadow: 0 4px 8px rgba(0, 255, 0, 0.1);
    }
    .tweet.new-tweet {
      border: 1px solid #0f03;
      margin-bottom: 20px;
      background: rgba(0, 255, 0, 0.02);
    }
    .tweet.new-tweet.editing {
      background: rgba(0, 255, 0, 0.05);
    }
    .tweet.new-tweet .content {
      color: #0f07;
    }
    .tweet.new-tweet.editing .content {
      color: #0f0;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      -webkit-app-region: no-drag;
    }
    .controls button {
      flex: 0 0 auto;
    }
    .shortcuts h3 {
      color: #0f0;
      text-align: center;
      margin-top: 0;
    }
    .shortcuts ul {
      list-style-type: none;
      padding: 0;
    }
    .shortcuts li {
      margin: 10px 0;
      color: #0f0;
    }
    kbd {
      background-color: #111;
      border: 1px solid #0f0;
      border-radius: 3px;
      box-shadow: 0 1px 1px rgba(0, 255, 0, 0.2);
      color: #0f0;
      display: inline-block;
      font-size: 0.85em;
      font-family: 'Orbitron', sans-serif;
      line-height: 1;
      padding: 2px 4px;
      white-space: nowrap;
    }
    .tweet.focused {
      border-left: 5px solid #ff0 !important;
      background: rgba(255, 255, 0, 0.08) !important;
      box-shadow: 0 0 15px rgba(255, 255, 0, 0.3) !important;
      position: relative;
      z-index: 2;
    }
    .tweet.focused::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid rgba(255, 255, 0, 0.3);
      pointer-events: none;
      z-index: -1;
    }
    .tweet.focused .content {
      color: #ff0 !important;
      text-shadow: 0 0 2px rgba(255, 255, 0, 0.5) !important;
    }
    .tweet.focused:hover {
      background: rgba(255, 255, 0, 0.1) !important;
    }
    .tweet.focused:focus {
      background: rgba(255, 255, 0, 0.12) !important;
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.4) !important;
    }
    .focus-indicator {
      display: inline-block;
      margin-right: 8px;
      color: #ff0;
      font-size: 16px;
      text-shadow: 0 0 5px rgba(255, 255, 0, 0.7);
    }
  </style>
</head>
<body>
  <div class="controls-info" style="display: none; flex-direction: column; gap: 10px;">
    <h3 style="color: #0f0; text-align: center; margin-bottom: 10px;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
    
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <div class="shortcut-group">
        <span class="key">j</span>
        <span>æ¬¡ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸ç§»å‹•</span>
      </div>
      <div class="shortcut-group">
        <span class="key">k</span>
        <span>å‰ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸ç§»å‹•</span>
      </div>
      <div class="shortcut-group">
        <span class="key">i</span>
        <span>é¸æŠä¸­ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ç·¨é›†</span>
      </div>
      <div class="shortcut-group">
        <span class="key">d</span>
        <span>é¸æŠä¸­ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å‰Šé™¤</span>
      </div>
      <div class="shortcut-group">
        <span class="key">o</span>
        <span>é¸æŠä¸­ã®ãƒ„ã‚¤ãƒ¼ãƒˆã«è¿”ä¿¡ï¼ˆå­ãƒ„ã‚¤ãƒ¼ãƒˆè¿½åŠ ï¼‰</span>
      </div>
      <div class="shortcut-group">
        <span class="key">space</span>
        <span>é¸æŠä¸­ã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å­ãƒ„ã‚¤ãƒ¼ãƒˆè¡¨ç¤º/éè¡¨ç¤º</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">n</span>
        <span>æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">enter</span>
        <span>ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿/ç·¨é›†å®Œäº†</span>
      </div>
      <div class="shortcut-group">
        <span class="key">esc</span>
        <span>ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">s</span>
        <span>ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹/åœæ­¢</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">s</span>
        <span>ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">e</span>
        <span>ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">j</span>
        <span>ãƒ„ã‚¤ãƒ¼ãƒˆã‚’JSONã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">i</span>
        <span>JSONã‹ã‚‰ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">m</span>
        <span>JSONã‹ã‚‰ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒãƒ¼ã‚¸</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">shift</span><span class="key-separator">+</span><span class="key">d</span>
        <span>å…¨ãƒ„ã‚¤ãƒ¼ãƒˆå‰Šé™¤</span>
      </div>
      <div class="shortcut-group">
        <span class="key">âŒ˜</span><span class="key-separator">+</span><span class="key">?</span>
        <span>ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º/éè¡¨ç¤º</span>
      </div>
      <div class="shortcut-group">
        <span class="key">f</span>
        <span>é¸æŠä¸­ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤</span>
      </div>
    </div>
  </div>
  <h1>Mind Clock</h1>
  <div id="timerDisplay">
    <span class="time">00:00:00</span>
    <div class="timer-controls">
      <button class="timer-button play-pause" onclick="toggleTimer()">â–¶</button>
      <button class="timer-button reset" onclick="resetTimer()">â†º</button>
    </div>
  </div>
  <div id="message"></div>
  <div id="tweets"></div>
  <div class="controls">
    <button id="exportBtn" title="Export tweets (Ctrl+Shift+E)">Export</button>
    <button id="flushBtn" title="Delete all tweets (Ctrl+Shift+D)">Delete All</button>
    <!-- JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
    <button id="exportJsonBtn" title="Export as JSON">Export JSON</button>
    <button id="importJsonBtn" title="Import from JSON">Import JSON</button>
    <button id="mergeJsonBtn" title="Merge with JSON">Merge JSON</button>
    <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
    <button id="toggleControlsBtn" title="Toggle shortcuts (Ctrl+?)">Shortcuts</button>
    <button id="focusBtn" title="Focus on selected tweet (Ctrl+F)">Focus</button>
  </div>

  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-message">å…¨ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="confirmFlush()">OK</button>
        <button class="modal-btn cancel" onclick="cancelFlush()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    let tweetArray = [];

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    function isEditing() {
      return document.querySelector('.tweet.editing') !== null;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener('DOMContentLoaded', async () => {
      // ãƒ„ã‚¤ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿
      try {
        tweetArray = await ipcRenderer.invoke('load-tweets');
        refreshTweetDisplay(tweetArray);
        
        // ãƒ„ã‚¤ãƒ¼ãƒˆè¡¨ç¤ºå¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆé…å»¶å®Ÿè¡Œï¼‰
        setTimeout(() => {
          console.log('Delayed focus state restoration');
          restoreFocusState();
        }, 200);
      } catch (error) {
        console.error('Failed to load tweets:', error);
        showMessage('ãƒ„ã‚¤ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›æ¬„ã®è¨­å®š
      const newTweetElement = document.querySelector('.tweet.new-tweet');
      if (newTweetElement) {
        newTweetElement.addEventListener('click', () => {
          if (!newTweetElement.classList.contains('editing')) {
            enterNewTweetEditMode(newTweetElement);
          }
        });
      }

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('exportBtn').addEventListener('click', exportTweets);
      
      // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('exportJsonBtn').addEventListener('click', exportTweetsAsJson);
      
      // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('importJsonBtn').addEventListener('click', importTweetsFromJson);
      
      // JSONãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('mergeJsonBtn').addEventListener('click', mergeTweetsFromJson);
      
      // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('toggleControlsBtn').addEventListener('click', () => {
        const controls = document.querySelector('.controls-info');
        controls.style.display = controls.style.display === 'none' || controls.style.display === '' ? 'flex' : 'none';
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('focusBtn').addEventListener('click', () => {
        console.log('Focus button clicked');
        // ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆãŒãªã„å ´åˆã¯ã€æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
        const currentFocus = document.activeElement;
        if (!currentFocus || !currentFocus.classList.contains('tweet') || currentFocus.classList.contains('child-tweet') || currentFocus.classList.contains('new-tweet')) {
          const firstTweet = document.querySelector('.tweet:not(.child-tweet):not(.new-tweet)');
          if (firstTweet) {
            firstTweet.focus();
            console.log('Focus moved to first tweet');
          }
        }
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ©Ÿèƒ½ã‚’å®Ÿè¡Œ
        toggleFocusOnTweet();
      });
      
      // å…¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.querySelector('.flush-btn').addEventListener('click', flushTweets);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('confirmFlushBtn').addEventListener('click', confirmFlush);
      document.getElementById('cancelFlushBtn').addEventListener('click', cancelFlush);
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è¨­å®š
    document.addEventListener('keydown', (e) => {
      // ç·¨é›†ä¸­ã®å ´åˆã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–
      if (isEditing() && e.key !== 'Escape') {
        return;
      }

      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ› (âŒ˜/Ctrl + N)
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
        e.preventDefault();
        const newTweetElement = document.querySelector('.tweet.new-tweet');
        if (newTweetElement && !newTweetElement.classList.contains('editing')) {
          enterNewTweetEditMode(newTweetElement);
        }
        return;
      }

      // é¸æŠã•ã‚ŒãŸãƒ„ã‚¤ãƒ¼ãƒˆã®ç·¨é›† (iã‚­ãƒ¼)
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && e.key.toLowerCase() === 'i') {
        e.preventDefault();
        const focusedTweet = document.activeElement;
        if (focusedTweet && focusedTweet.classList.contains('tweet')) {
          if (focusedTweet.classList.contains('child-tweet')) {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®ç·¨é›†
            const parentIndex = parseInt(focusedTweet.getAttribute('data-parent-index'));
            const childIndex = parseInt(focusedTweet.getAttribute('data-child-index'));
            if (!isNaN(parentIndex) && !isNaN(childIndex)) {
              editChildTweet(parentIndex, childIndex);
            }
          } else if (!focusedTweet.classList.contains('new-tweet')) {
            // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®ç·¨é›†
            const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
            if (!isNaN(actualIndex)) {
              editTweet(actualIndex);
            }
          }
        }
        return;
      }

      // ãƒ„ã‚¤ãƒ¼ãƒˆé–“ã®ç§»å‹• (j/kã‚­ãƒ¼)
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && (e.key === 'j' || e.key === 'k')) {
        e.preventDefault();
        const currentFocus = document.activeElement;
        
        if (!currentFocus || !currentFocus.classList.contains('tweet')) {
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒãƒ„ã‚¤ãƒ¼ãƒˆã«ãªã„å ´åˆã¯æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          const firstTweet = document.querySelector('.tweet:not(.new-tweet)');
          if (firstTweet) {
            firstTweet.focus();
          }
          return;
        }
        
        // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆè¦ªã¨å±•é–‹ã•ã‚Œã¦ã„ã‚‹å­ï¼‰ã‚’å–å¾—
        const parentTweets = Array.from(document.querySelectorAll('.tweet:not(.child-tweet):not(.new-tweet)'));
        const expandedChildren = Array.from(document.querySelectorAll('.children-container.expanded .tweet.child-tweet'));
        const visibleTweets = [...parentTweets, ...expandedChildren].sort((a, b) => {
          // DOMã§ã®ä½ç½®ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆ
          return a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1;
        });
        
        // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèª
        const hasExpandedChildren = document.querySelector('.children-container.expanded') !== null;
        
        if (hasExpandedChildren) {
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
          const visibleIndex = visibleTweets.indexOf(currentFocus);
          
          if (e.key === 'j') {
            // æ¬¡ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸ï¼ˆè‡ªåˆ†ã®å­ãƒ„ã‚¤ãƒ¼ãƒˆã¸ï¼‰
            if (visibleIndex < visibleTweets.length - 1) {
              visibleTweets[visibleIndex + 1]?.focus();
            } else {
              // æœ€å¾Œã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
              visibleTweets[0]?.focus();
            }
          } else {
            // å‰ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸
            if (visibleIndex > 0) {
              visibleTweets[visibleIndex - 1]?.focus();
            } else {
              // æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
              visibleTweets[visibleTweets.length - 1]?.focus();
            }
          }
        } else {
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€è¦ªãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
          const parentTweetIndex = parentTweets.indexOf(currentFocus);
          
          if (e.key === 'j') {
            // æ¬¡ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
            if (parentTweetIndex < parentTweets.length - 1) {
              parentTweets[parentTweetIndex + 1]?.focus();
            } else {
              // æœ€å¾Œã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
              parentTweets[0]?.focus();
            }
          } else {
            // å‰ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
            if (parentTweetIndex > 0) {
              parentTweets[parentTweetIndex - 1]?.focus();
            } else {
              // æœ€åˆã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
              parentTweets[parentTweets.length - 1]?.focus();
            }
          }
        }
        return;
      }

      // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§ã®è¡¨ç¤º/éè¡¨ç¤º (âŒ˜/Ctrl + ?)
      if ((e.ctrlKey || e.metaKey) && (e.key === '?' || e.key === '/')) {
        e.preventDefault();
        const controls = document.querySelector('.controls-info');
        controls.style.display = controls.style.display === 'none' || controls.style.display === '' ? 'flex' : 'none';
        return;
      }

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ©Ÿèƒ½ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ (f)
      if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key === 'f') {
        e.preventDefault();
        console.log('Focus shortcut triggered');
        
        // ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆãŒãªã„å ´åˆã¯ã€æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
        const currentFocus = document.activeElement;
        if (!currentFocus || !currentFocus.classList.contains('tweet') || currentFocus.classList.contains('child-tweet') || currentFocus.classList.contains('new-tweet')) {
          const firstTweet = document.querySelector('.tweet:not(.child-tweet):not(.new-tweet)');
          if (firstTweet) {
            firstTweet.focus();
            console.log('Focus moved to first tweet by shortcut');
          }
        }
        
        toggleFocusOnTweet();
        return;
      }

      // ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹/åœæ­¢ (âŒ˜/Ctrl + S)
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === 's') {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¿å­˜å‹•ä½œã‚’é˜²ã
        toggleTimer();
        return;
      }

      // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒªã‚»ãƒƒãƒˆ (âŒ˜/Ctrl + Shift + S)
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        resetTimer();
        return;
      }

      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ› (âŒ˜/Ctrl + N)
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === 'n') {
        e.preventDefault();
        const newTweet = document.querySelector('.tweet.new-tweet');
        if (newTweet) {
          newTweet.focus();
          enterNewTweetEditMode(newTweet);
        }
        return;
      }

      // iã‚­ãƒ¼ã§ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ç·¨é›†
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && e.key.toLowerCase() === 'i') {
        e.preventDefault();
        const focusedTweet = document.activeElement;
        if (focusedTweet && focusedTweet.classList.contains('tweet')) {
          if (focusedTweet.classList.contains('new-tweet')) {
            enterNewTweetEditMode(focusedTweet);
          } else if (focusedTweet.classList.contains('child-tweet')) {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®ç·¨é›†
            const parentIndex = parseInt(focusedTweet.getAttribute('data-parent-index'));
            const childIndex = parseInt(focusedTweet.getAttribute('data-child-index'));
            if (!isNaN(parentIndex) && !isNaN(childIndex)) {
              editChildTweet(parentIndex, childIndex);
            }
          } else {
            // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®ç·¨é›†
            const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
            if (!isNaN(actualIndex)) {
              editTweet(actualIndex);
            }
          }
        }
        return;
      }

      // j,kã‚­ãƒ¼ã§ã®ç§»å‹•
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && (e.key === 'j' || e.key === 'k')) {
        e.preventDefault();
        const allTweets = Array.from(document.querySelectorAll('.tweet'));
        const currentFocus = document.activeElement;
        let currentIndex = allTweets.indexOf(currentFocus);

        // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒãƒ„ã‚¤ãƒ¼ãƒˆä¸Šã«ãªã„å ´åˆã¯ã€æœ€åˆ/æœ€å¾Œã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (currentIndex === -1) {
          if (e.key === 'j') {
            allTweets[0]?.focus();
          } else {
            allTweets[allTweets.length - 1]?.focus();
          }
          return;
        }

        // ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ã®ãŒå­ãƒ„ã‚¤ãƒ¼ãƒˆã‹ã©ã†ã‹
        const isChildTweet = currentFocus.classList.contains('child-tweet');
        
        // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®ã¿ã‚’å–å¾—
        const parentTweets = Array.from(document.querySelectorAll('.tweet:not(.child-tweet)'));
        
        // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å«ã‚€ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å–å¾—
        const visibleTweets = Array.from(document.querySelectorAll('.tweet:not(.child-tweet), .children-container.expanded .tweet.child-tweet'));
        
        if (isChildTweet) {
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆ
          const parentIndex = parseInt(currentFocus.getAttribute('data-parent-index'));
          const parentTweet = document.querySelector(`.tweet[data-actual-index="${parentIndex}"]`);
          
          // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const childrenContainer = document.querySelector(`.children-container[data-parent-index="${parentIndex}"]`);
          const isExpanded = childrenContainer && childrenContainer.classList.contains('expanded');
          
          if (isExpanded) {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
            const visibleIndex = visibleTweets.indexOf(currentFocus);
            
            if (e.key === 'j') {
              // æ¬¡ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (visibleIndex < visibleTweets.length - 1) {
                visibleTweets[visibleIndex + 1]?.focus();
              } else {
                // æœ€å¾Œã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
                visibleTweets[0]?.focus();
              }
            } else {
              // å‰ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (visibleIndex > 0) {
                visibleTweets[visibleIndex - 1]?.focus();
              } else {
                // æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
                visibleTweets[visibleTweets.length - 1]?.focus();
              }
            }
          } else {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€è¦ªãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
            const parentTweetIndex = parentTweets.indexOf(parentTweet);
            
            if (e.key === 'j') {
              // æ¬¡ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (parentTweetIndex < parentTweets.length - 1) {
                parentTweets[parentTweetIndex + 1]?.focus();
              } else {
                // æœ€å¾Œã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
                parentTweets[0]?.focus();
              }
            } else {
              // å‰ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (parentTweetIndex > 0) {
                parentTweets[parentTweetIndex - 1]?.focus();
              } else {
                // æœ€åˆã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
                parentTweets[parentTweets.length - 1]?.focus();
              }
            }
          }
        } else {
          // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆ
          // ã“ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const actualIndex = parseInt(currentFocus.getAttribute('data-actual-index'));
          const childrenContainer = document.querySelector(`.children-container[data-parent-index="${actualIndex}"]`);
          const isExpanded = childrenContainer && childrenContainer.classList.contains('expanded');
          
          if (isExpanded && childrenContainer.querySelectorAll('.tweet.child-tweet').length > 0) {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
            const visibleIndex = visibleTweets.indexOf(currentFocus);
            
            if (e.key === 'j') {
              // æ¬¡ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸ï¼ˆè‡ªåˆ†ã®å­ãƒ„ã‚¤ãƒ¼ãƒˆã¸ï¼‰
              if (visibleIndex < visibleTweets.length - 1) {
                visibleTweets[visibleIndex + 1]?.focus();
              } else {
                // æœ€å¾Œã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
                visibleTweets[0]?.focus();
              }
            } else {
              // å‰ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (visibleIndex > 0) {
                visibleTweets[visibleIndex - 1]?.focus();
              } else {
                // æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
                visibleTweets[visibleTweets.length - 1]?.focus();
              }
            }
          } else {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€è¦ªãƒ„ã‚¤ãƒ¼ãƒˆé–“ã‚’ç§»å‹•
            const parentTweetIndex = parentTweets.indexOf(currentFocus);
            
            if (e.key === 'j') {
              // æ¬¡ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (parentTweetIndex < parentTweets.length - 1) {
                parentTweets[parentTweetIndex + 1]?.focus();
              } else {
                // æœ€å¾Œã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹
                parentTweets[0]?.focus();
              }
            } else {
              // å‰ã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã¸
              if (parentTweetIndex > 0) {
                parentTweets[parentTweetIndex - 1]?.focus();
              } else {
                // æœ€åˆã®è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å ´åˆã¯æœ€å¾Œã«ç§»å‹•
                parentTweets[parentTweets.length - 1]?.focus();
              }
            }
          }
        }
        return;
      }

      // é¸æŠã•ã‚ŒãŸãƒ„ã‚¤ãƒ¼ãƒˆã®å‰Šé™¤ (dã‚­ãƒ¼)
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && e.key.toLowerCase() === 'd') {
        e.preventDefault();
        const focusedTweet = document.activeElement;
        if (focusedTweet && focusedTweet.classList.contains('tweet')) {
          if (focusedTweet.classList.contains('child-tweet')) {
            // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®å‰Šé™¤
            const parentIndex = parseInt(focusedTweet.getAttribute('data-parent-index'));
            const childIndex = parseInt(focusedTweet.getAttribute('data-child-index'));
            if (!isNaN(parentIndex) && !isNaN(childIndex)) {
              deleteChildTweet(parentIndex, childIndex);
            }
          } else if (!focusedTweet.classList.contains('new-tweet')) {
            // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å‰Šé™¤
            const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
            if (!isNaN(actualIndex)) {
              deleteTweet(actualIndex);
            }
          }
        }
        return;
      }

      // rã‚­ãƒ¼ã§é¸æŠã•ã‚ŒãŸãƒ„ã‚¤ãƒ¼ãƒˆã«è¿”ä¿¡ï¼ˆå­ãƒ„ã‚¤ãƒ¼ãƒˆè¿½åŠ ï¼‰
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && e.key.toLowerCase() === 'o') {
        e.preventDefault();
        const focusedTweet = document.activeElement;
        if (focusedTweet && focusedTweet.classList.contains('tweet') && !focusedTweet.classList.contains('new-tweet') && !focusedTweet.classList.contains('child-tweet')) {
          const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
          if (!isNaN(actualIndex)) {
            addChildTweet(actualIndex);
          }
        }
        return;
      }

      // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³æ©Ÿèƒ½ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‰
      if (!e.ctrlKey && !e.metaKey && !e.shiftKey && e.key === ' ') {
        e.preventDefault();
        const focusedTweet = document.activeElement;
        if (focusedTweet && focusedTweet.classList.contains('tweet') && !focusedTweet.classList.contains('child-tweet') && !focusedTweet.classList.contains('new-tweet')) {
          const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
          if (!isNaN(actualIndex)) {
            toggleChildrenVisibility(actualIndex);
          }
        }
        return;
      }
    });

    const tweetEffects = [
      {
        name: 'matrix-effect',
        duration: 1000
      }
    ];

    async function postTweet(content) {
      if (content) {
        const newTweet = {
          content: content.replace(/\n/g, '<br>'),
          timestamp: new Date().toISOString(),
          children: [] // å­ãƒ„ã‚¤ãƒ¼ãƒˆé…åˆ—ã‚’åˆæœŸåŒ–
        };

        try {
          // ã¾ãšæ°¸ç¶šåŒ–ã‚’è©¦ã¿ã‚‹
          tweetArray.push(newTweet);
          await ipcRenderer.invoke('save-tweets', tweetArray);

          // æ°¸ç¶šåŒ–æˆåŠŸå¾Œã«UIã‚’æ›´æ–°
          const actualIndex = tweetArray.length - 1; // æ–°ã—ã„ãƒ„ã‚¤ãƒ¼ãƒˆã®å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
          const tweet = createTweetElement(newTweet, 0, actualIndex);
          
          // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›æ¬„ã®å¾Œã«æŒ¿å…¥
          const newTweetElement = document.querySelector('.tweet.new-tweet');
          if (newTweetElement && newTweetElement.nextSibling) {
            document.getElementById('tweets').insertBefore(tweet, newTweetElement.nextSibling);
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
            document.getElementById('tweets').prepend(tweet);
          }

          // æ—¢å­˜ã®ãƒ„ã‚¤ãƒ¼ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
          const existingTweets = document.querySelectorAll('.tweet:not(.new-tweet):not(.child-tweet)');
          existingTweets.forEach(existingTweet => {
            // æ–°ã—ãè¿½åŠ ã—ãŸãƒ„ã‚¤ãƒ¼ãƒˆä»¥å¤–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            if (existingTweet !== tweet) {
              const oldIndex = parseInt(existingTweet.getAttribute('data-index'));
              existingTweet.setAttribute('data-index', oldIndex + 1);
            }
          });

          // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
          tweet.classList.add('matrix-effect');
          setTimeout(() => {
            tweet.classList.remove('matrix-effect');
          }, 1000);

          return true;
        } catch (error) {
          console.error('Failed to save tweet:', error);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€é…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦å…ƒã«æˆ»ã™
          tweetArray.pop();
          throw error;
        }
      }
      return false;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / (1000 * 60));

      // 1åˆ†æœªæº€ã¯ã€ŒNOWã€ã¨è¡¨ç¤º
      if (diffMinutes < 1) return 'NOW';
      
      // æ—¥ä»˜ã¨æ™‚åˆ»ã‚’ã€Œmm/dd hh:mmã€å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${month}/${day} ${hours}:${minutes}`;
    }

    let timer;
    let startTime;
    let accumulatedTime = 0;
    let running = false;

    const coolMessages = [
      "Data has been launched into the cosmos ğŸš€",
      "Your words are now beyond infinity!",
      "The Enter key can't believe this!",
      "This moment has changed the world!",
      "Magic of coding unleashed!",
      "Information has transcended dimensions!",
      "This copy is rare indeed!",
      "Invincible paste ready!",
      "Text is transcending dimensions!",
      "Data races through the network!",
      "This copy will go down in history!",
      "Your message shines brightly!",
      "Copy complete, grand departure!",
      "Astonishing coding power!",
      "First step into uncharted territory!",
      "Thought has been materialized!",
      "Data races through time and space!",
      "Information moving at light speed!",
      "Everyone praises this copy!",
      "Legendary copy complete!",
      "Your input is now reaching the future!",
      "Inspiration is unstoppable!",
      "Infinite possibilities take flight!",
      "The best copy, surprising the world!",
      "Imagination has been digitized!",
      "The future awaits you!",
      "This text is art at heart!",
      "Information moving like lightning!",
      "Message has soared into the universe!",
      "Input complete, infinite possibilities ahead!"
    ];

    function autoResize(elem) {
      const minHeight = 80; // æœ€å°ã®é«˜ã•ã‚‚80pxã«

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®é«˜ã•ã‚’æ­£ç¢ºã«è¨ˆæ¸¬ã™ã‚‹ãŸã‚ã®ä¸€æ™‚çš„ãªé«˜ã•ãƒªã‚»ãƒƒãƒˆ
      elem.style.height = 'auto';

      // å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é«˜ã•ã‚’å–å¾—ï¼ˆæœ€å°å€¤ã¯ä¿æŒï¼‰
      const newHeight = Math.max(elem.scrollHeight, minHeight);

      // ç¾åœ¨ã®é«˜ã•ã¨æ–°ã—ã„é«˜ã•ãŒç•°ãªã‚‹å ´åˆã®ã¿æ›´æ–°
      if (elem.clientHeight !== newHeight) {
        elem.style.height = newHeight + 'px';
      }
    }

    function updateTimerDisplay() {
      if (!running && accumulatedTime === 0) {
        document.querySelector('#timerDisplay .time').textContent = "Click to Start";
        return;
      }
      const elapsed = Math.floor((Date.now() - startTime + accumulatedTime) / 1000);
      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      document.querySelector('#timerDisplay .time').textContent =
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function copyToClipboard() {
      try {
        await navigator.clipboard.writeText(taskInput);
        const message = coolMessages[Math.floor(Math.random() * coolMessages.length)];
        showMessage(message);
      } catch (err) {
        console.error('Failed to copy to clipboard:', err);
      }
    }

    function showMessage(text) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    function toggleTimer() {
      if (running) {
        stopTimer();
      } else {
        startTimer();
      }
    }

    function startTimer() {
      if (!running) {
        running = true;
        startTime = Date.now();
        timer = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
        document.getElementById('timerDisplay').classList.add('running');
        document.querySelector('.timer-button.play-pause').textContent = 'â¸';
      }
    }

    function stopTimer() {
      if (running) {
        running = false;
        clearInterval(timer);
        accumulatedTime += Date.now() - startTime;
        document.getElementById('timerDisplay').classList.remove('running');
        document.querySelector('.timer-button.play-pause').textContent = 'â–¶';
      }
    }

    function resetTimer() {
      running = false;
      clearInterval(timer);
      accumulatedTime = 0
      document.querySelector('#timerDisplay .time').textContent = "00:00:00";
      document.getElementById('timerDisplay').classList.remove('running');
      document.querySelector('.timer-button.play-pause').textContent = 'â–¶';
    }

    // ã‚¿ã‚¤ãƒãƒ¼ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    document.querySelector('#timerDisplay .time').addEventListener('click', function(e) {
      toggleTimer();
    });

    async function exportTweets() {
      try {
        let exportText = '';
        
        // ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æ–°ã—ã„é †ã«å‡¦ç†
        for (let i = tweetArray.length - 1; i >= 0; i--) {
          const tweet = tweetArray[i];
          
          // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å†…å®¹ã¨æ™‚é–“ã‚’è¿½åŠ 
          const tweetDate = new Date(tweet.timestamp);
          const tweetDateStr = tweetDate.toLocaleString('ja-JP');
          exportText += `${tweetDateStr}  ${tweet.content.replace(/<br>/g, '\n')}\n\n`;
          
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒã‚ã‚Œã°è¿½åŠ 
          if (tweet.children && tweet.children.length > 0) {
            tweet.children.forEach(childTweet => {
              // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®æ™‚é–“ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ 
              const childDate = new Date(childTweet.timestamp);
              const childDateStr = childDate.toLocaleString('ja-JP');
              exportText += `\t${childDateStr}  ${childTweet.content.replace(/<br>/g, '\n').replace(/\n/g, '\n\t')}\n\n`;
            });
          }
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ - æ”¹å–„ç‰ˆ
        try {
          // éåŒæœŸAPIã‚’ä½¿ç”¨
          await navigator.clipboard.writeText(exportText);
          showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚');
        } catch (clipboardErr) {
          console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIã‚¨ãƒ©ãƒ¼:', clipboardErr);
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¸€æ™‚çš„ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
          const textArea = document.createElement('textarea');
          textArea.value = exportText;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            const successful = document.execCommand('copy');
            if (successful) {
              showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚');
            } else {
              throw new Error('execCommand copy failed');
            }
          } catch (execErr) {
            console.error('execCommand ã‚¨ãƒ©ãƒ¼:', execErr);
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          } finally {
            document.body.removeChild(textArea);
          }
        }
      } catch (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    async function exportTweetsAsJson() {
      try {
        const tweets = await ipcRenderer.invoke('export-tweets-json');
        if (tweets.length === 0) {
          alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        // JSONãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const jsonData = JSON.stringify(tweets, null, 2);
        
        // Blobã‚’ä½œæˆ
        const blob = new Blob([jsonData], { type: 'application/json' });
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«å«ã‚ã‚‹
        const now = new Date();
        const dateStr = now.toISOString().replace(/[:.]/g, '-').replace('T', '_').split('Z')[0];
        a.download = `mind_clock_export_${dateStr}.json`;
        
        
        // ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        document.body.appendChild(a);
        a.click();
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        showMessage('JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼');
      } catch (error) {
        console.error('JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    async function importTweetsFromJson() {
      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const fileInput = document.getElementById('jsonFileInput');
        fileInput.onchange = async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const jsonData = JSON.parse(e.target.result);
              
              // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
              if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚')) {
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä¸Šæ›¸ãï¼‰
                const importedTweets = await ipcRenderer.invoke('import-tweets-json', jsonData);
                refreshTweetDisplay(importedTweets);
                showMessage('JSONãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼');
              } else {
                // ãƒãƒ¼ã‚¸
                const mergedTweets = await ipcRenderer.invoke('merge-tweets-json', jsonData);
                refreshTweetDisplay(mergedTweets);
                showMessage('JSONãƒ‡ãƒ¼ã‚¿ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼');
              }
            } catch (error) {
              console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
              alert(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
          };
          reader.readAsText(file);
        };
        
        fileInput.click();
      } catch (error) {
        console.error('JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // JSONãƒãƒ¼ã‚¸æ©Ÿèƒ½
    async function mergeTweetsFromJson() {
      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const fileInput = document.getElementById('jsonFileInput');
        fileInput.onchange = async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const jsonData = JSON.parse(e.target.result);
              
              // ãƒãƒ¼ã‚¸å‡¦ç†
              const mergedTweets = await ipcRenderer.invoke('merge-tweets-json', jsonData);
              refreshTweetDisplay(mergedTweets);
              showMessage('JSONãƒ‡ãƒ¼ã‚¿ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼');
            } catch (error) {
              console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
              alert(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
          };
          reader.readAsText(file);
        };
        
        fileInput.click();
      } catch (error) {
        console.error('JSONãƒãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼:', error);
        alert(`ãƒãƒ¼ã‚¸ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // ãƒ„ã‚¤ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹å…±é€šé–¢æ•°
    function refreshTweetDisplay(tweets) {
      tweetArray = tweets;
      const tweetsContainer = document.getElementById('tweets');
      tweetsContainer.innerHTML = '';
      
      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›æ¬„ã‚’è¿½åŠ ï¼ˆæœ€åˆã«ï¼‰
      const newTweetElement = document.createElement('div');
      newTweetElement.className = 'tweet new-tweet';
      newTweetElement.setAttribute('tabindex', '0');
      newTweetElement.innerHTML = `
        <span class="content">Initialize thought sequence...</span>
      `;
      tweetsContainer.appendChild(newTweetElement);
      
      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›æ¬„ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      newTweetElement.addEventListener('click', () => {
        if (!newTweetElement.classList.contains('editing')) {
          enterNewTweetEditMode(newTweetElement);
        }
      });
      
      // ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼ˆæ–°ã—ã„é †ï¼‰
      for (let idx = 0; idx < tweetArray.length; idx++) {
        const tweetIndex = tweetArray.length - 1 - idx; // è¡¨ç¤ºé †åºã¯é€†ã ãŒã€å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
        const tweet = tweetArray[tweetIndex];
        
        // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã‚’ä½œæˆ
        const tweetElement = createTweetElement(tweet, idx, tweetIndex);
        tweetsContainer.appendChild(tweetElement);
        
        // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã¯å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
        if (tweet.children && tweet.children.length > 0) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'children-container expanded'; // åŸºæœ¬çš„ã«è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
          childrenContainer.setAttribute('data-parent-index', tweetIndex);
          
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¡¨ç¤º
          tweet.children.forEach((childTweet, childIdx) => {
            const childElement = createChildTweetElement(childTweet, childIdx, tweetIndex);
            childrenContainer.appendChild(childElement);
          });
          
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å¾Œã«è¿½åŠ 
          tweetsContainer.insertBefore(childrenContainer, tweetElement.nextSibling);
          
          // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã«å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¿½åŠ 
          const hasChildrenIndicator = document.createElement('span');
          hasChildrenIndicator.className = 'has-children-indicator';
          hasChildrenIndicator.textContent = 'â–¼'; // åŸºæœ¬çš„ã«é–‹ã„ãŸçŠ¶æ…‹
          hasChildrenIndicator.setAttribute('title', 'å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¡¨ç¤º/éè¡¨ç¤º');
          hasChildrenIndicator.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleChildrenVisibility(tweetIndex);
          });
          
          // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å‰ã«è¿½åŠ 
          const contentSpan = tweetElement.querySelector('.content');
          tweetElement.insertBefore(hasChildrenIndicator, contentSpan);
        }
      }
      
      console.log('Refreshed tweet display, now restoring focus state');
      
      // ãƒ„ã‚¤ãƒ¼ãƒˆè¡¨ç¤ºå¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒ
      setTimeout(() => {
        restoreFocusState();
      }, 100);
    }

    // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆè¦ç´ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createTweetElement(tweet, displayIndex, actualIndex) {
      const tweetElement = document.createElement('div');
      tweetElement.className = 'tweet';
      tweetElement.setAttribute('data-text', tweet.content);
      tweetElement.setAttribute('data-index', displayIndex); // è¡¨ç¤ºé †ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®šï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
      tweetElement.setAttribute('data-actual-index', actualIndex); // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚ä¿å­˜
      tweetElement.setAttribute('tabindex', '0');
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨æ™‚é–“ã‚’åˆ¥ã€…ã«ä½œæˆã—ã¦è¿½åŠ 
      const contentSpan = document.createElement('span');
      contentSpan.className = 'content';
      contentSpan.innerHTML = tweet.content; // innerHTMLã‚’ä½¿ç”¨ã—ã¦<br>ã‚¿ã‚°ã‚’æ­£ã—ãè§£é‡ˆ
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = formatTime(tweet.timestamp);
      
      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'tweet-actions';
      
      // è¿”ä¿¡ãƒœã‚¿ãƒ³
      const replyButton = document.createElement('span');
      replyButton.className = 'tweet-action reply-action';
      replyButton.textContent = 'â†©';
      replyButton.setAttribute('title', 'è¿”ä¿¡ã™ã‚‹');
      replyButton.addEventListener('click', (e) => {
        e.stopPropagation();
        addChildTweet(actualIndex);
      });
      
      actionsDiv.appendChild(replyButton);
      
      tweetElement.appendChild(contentSpan);
      tweetElement.appendChild(actionsDiv);
      tweetElement.appendChild(timeSpan);
      
      return tweetElement;
    }

    // å­ãƒ„ã‚¤ãƒ¼ãƒˆè¦ç´ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createChildTweetElement(childTweet, childIndex, parentIndex) {
      const childElement = document.createElement('div');
      childElement.className = 'tweet child-tweet';
      childElement.setAttribute('data-text', childTweet.content);
      childElement.setAttribute('data-child-index', childIndex);
      childElement.setAttribute('data-parent-index', parentIndex);
      childElement.setAttribute('tabindex', '0');
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
      const childIndicator = document.createElement('span');
      childIndicator.className = 'child-indicator';
      childIndicator.textContent = 'â†ª';
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨æ™‚é–“ã‚’åˆ¥ã€…ã«ä½œæˆã—ã¦è¿½åŠ 
      const contentSpan = document.createElement('span');
      contentSpan.className = 'content';
      contentSpan.innerHTML = childTweet.content;
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = formatTime(childTweet.timestamp);
      
      childElement.appendChild(childIndicator);
      childElement.appendChild(contentSpan);
      childElement.appendChild(timeSpan);
      
      return childElement;
    }

    // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function toggleChildrenVisibility(parentIndex) {
      const childrenContainer = document.querySelector(`.children-container[data-parent-index="${parentIndex}"]`);
      if (childrenContainer) {
        childrenContainer.classList.toggle('expanded');
        
        // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®å‘ãã‚’å¤‰æ›´
        const parentTweet = document.querySelector(`.tweet[data-actual-index="${parentIndex}"]`);
        const indicator = parentTweet.querySelector('.has-children-indicator');
        if (indicator) {
          indicator.textContent = childrenContainer.classList.contains('expanded') ? 'â–¼' : 'â–¶';
        }
      }
    }

    // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    async function addChildTweet(parentIndex) {
      const parentTweet = document.querySelector(`.tweet[data-actual-index="${parentIndex}"]`);
      if (!parentTweet) return;
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›ç”¨ã®è¦ç´ ã‚’ä½œæˆ
      const childInputElement = document.createElement('div');
      childInputElement.className = 'tweet child-tweet editing';
      childInputElement.setAttribute('data-parent-index', parentIndex);
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
      const childIndicator = document.createElement('span');
      childIndicator.className = 'child-indicator';
      childIndicator.textContent = 'â†ª';
      
      // ç·¨é›†å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ 
      const contentSpan = document.createElement('span');
      contentSpan.className = 'content';
      contentSpan.contentEditable = true;
      contentSpan.textContent = '';
      
      childInputElement.appendChild(childIndicator);
      childInputElement.appendChild(contentSpan);
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
      let childrenContainer = document.querySelector(`.children-container[data-parent-index="${parentIndex}"]`);
      if (!childrenContainer) {
        childrenContainer = document.createElement('div');
        childrenContainer.className = 'children-container';
        childrenContainer.setAttribute('data-parent-index', parentIndex);
        
        // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®å¾Œã«å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’æŒ¿å…¥
        parentTweet.parentNode.insertBefore(childrenContainer, parentTweet.nextSibling);
        
        // è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã«å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆã¾ã ãªã‘ã‚Œã°ï¼‰
        if (!parentTweet.querySelector('.has-children-indicator')) {
          const hasChildrenIndicator = document.createElement('span');
          hasChildrenIndicator.className = 'has-children-indicator';
          hasChildrenIndicator.textContent = 'â–¶';
          hasChildrenIndicator.setAttribute('title', 'å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¡¨ç¤º/éè¡¨ç¤º');
          hasChildrenIndicator.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleChildrenVisibility(parentIndex);
          });
          
          // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¦ªãƒ„ã‚¤ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å‰ã«è¿½åŠ 
          const contentSpan = parentTweet.querySelector('.content');
          parentTweet.insertBefore(hasChildrenIndicator, contentSpan);
        }
      }
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
      childrenContainer.classList.add('expanded');
      
      // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®å‘ãã‚’å¤‰æ›´
      const indicator = parentTweet.querySelector('.has-children-indicator');
      if (indicator) {
        indicator.textContent = 'â–¼';
      }
      
      // å­ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›è¦ç´ ã‚’å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®å…ˆé ­ã«è¿½åŠ 
      childrenContainer.insertBefore(childInputElement, childrenContainer.firstChild);
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
      contentSpan.focus();
      
      // IMEå…¥åŠ›çŠ¶æ…‹ã‚’è¿½è·¡
      let isComposing = false;
      
      // IMEå…¥åŠ›é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionStart = () => {
        isComposing = true;
      };
      
      // IMEå…¥åŠ›çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionEnd = () => {
        isComposing = false;
      };
      
      // ç·¨é›†å®Œäº†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const handleEditKeypress = async (e) => {
        // cmd + enterã§ä¿å­˜
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && !isComposing) {
          e.preventDefault();
          e.stopPropagation();
          const newContent = contentSpan.textContent.trim();
          
          if (newContent) {
            try {
              // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¿½åŠ 
              const childTweet = {
                content: newContent.replace(/\n/g, '<br>'),
                timestamp: new Date().toISOString()
              };
              
              // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¿½åŠ 
              tweetArray = await ipcRenderer.invoke('add-child-tweet', parentIndex, childTweet);
              
              // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
              finishEditing();
              
              // ãƒ„ã‚¤ãƒ¼ãƒˆä¸€è¦§ã‚’å†æç”»
              refreshTweetDisplay(tweetArray);
            } catch (error) {
              console.error('Failed to add child tweet:', error);
              finishEditing();
            }
          } else {
            finishEditing();
          }
        } else if (e.key === 'Escape') {
          // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          e.preventDefault();
          e.stopPropagation();
          finishEditing();
        }
      };
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®å…±é€šå‡¦ç†
      const finishEditing = () => {
        document.removeEventListener('keydown', handleEditKeypress);
        contentSpan.removeEventListener('compositionstart', handleCompositionStart);
        contentSpan.removeEventListener('compositionend', handleCompositionEnd);
        
        // å…¥åŠ›è¦ç´ ã‚’å‰Šé™¤
        if (childInputElement.parentNode) {
          childInputElement.parentNode.removeChild(childInputElement);
        }
        
        // å­ãƒ„ã‚¤ãƒ¼ãƒˆãŒãªã„å ´åˆã¯å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’å‰Šé™¤
        const existingChildTweets = childrenContainer.querySelectorAll('.tweet.child-tweet:not(.editing)');
        if (existingChildTweets.length === 0) {
          // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
          if (childrenContainer.parentNode) {
            childrenContainer.parentNode.removeChild(childrenContainer);
          }
          
          // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’å‰Šé™¤
          if (indicator) {
            indicator.parentNode.removeChild(indicator);
          }
        }
      };
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('keydown', handleEditKeypress);
      contentSpan.addEventListener('compositionstart', handleCompositionStart);
      contentSpan.addEventListener('compositionend', handleCompositionEnd);
    }

    // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
    async function editChildTweet(parentIndex, childIndex) {
      const childTweet = document.querySelector(`.tweet.child-tweet[data-parent-index="${parentIndex}"][data-child-index="${childIndex}"]`);
      if (!childTweet) return;
      
      const contentSpan = childTweet.querySelector('.content');
      const originalContent = contentSpan.innerHTML.replace(/<br>/g, '\n');
      let isComposing = false;
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
      childTweet.classList.add('editing');
      contentSpan.contentEditable = true;
      contentSpan.textContent = originalContent;
      contentSpan.focus();
      
      // IMEå…¥åŠ›é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionStart = () => {
        isComposing = true;
      };
      
      // IMEå…¥åŠ›çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionEnd = () => {
        isComposing = false;
      };
      
      // ç·¨é›†å®Œäº†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const handleEditKeypress = async (e) => {
        // cmd + enterã§ä¿å­˜
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && !isComposing) {
          e.preventDefault();
          e.stopPropagation();
          const newContent = contentSpan.textContent.trim();
          
          if (newContent !== originalContent) {
            try {
              // å­ãƒ„ã‚¤ãƒ¼ãƒˆã®å†…å®¹ã‚’æ›´æ–°
              tweetArray = await ipcRenderer.invoke('edit-child-tweet', parentIndex, childIndex, newContent.replace(/\n/g, '<br>'));
              
              // è¡¨ç¤ºã‚’æ›´æ–°
              contentSpan.innerHTML = newContent.replace(/\n/g, '<br>');
              contentSpan.contentEditable = false;
              childTweet.classList.remove('editing');
              childTweet.focus();
            } catch (error) {
              console.error('Failed to edit child tweet:', error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®å†…å®¹ã«æˆ»ã™
              contentSpan.innerHTML = originalContent;
              finishEditing();
            }
          } else {
            finishEditing();
          }
        } else if (e.key === 'Escape') {
          // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          e.preventDefault();
          e.stopPropagation();
          contentSpan.innerHTML = originalContent;
          finishEditing();
        }
      };
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®å…±é€šå‡¦ç†
      const finishEditing = () => {
        contentSpan.contentEditable = false;
        childTweet.classList.remove('editing');
        childTweet.focus();
        document.removeEventListener('keydown', handleEditKeypress);
        contentSpan.removeEventListener('compositionstart', handleCompositionStart);
        contentSpan.removeEventListener('compositionend', handleCompositionEnd);
      };
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('keydown', handleEditKeypress);
      contentSpan.addEventListener('compositionstart', handleCompositionStart);
      contentSpan.addEventListener('compositionend', handleCompositionEnd);
    }

    // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
    async function deleteChildTweet(parentIndex, childIndex) {
      const childTweet = document.querySelector(`.tweet.child-tweet[data-parent-index="${parentIndex}"][data-child-index="${childIndex}"]`);
      if (!childTweet) return;
      
      if (!childTweet.classList.contains('confirm')) {
        // æœ€åˆã®ç¢ºèªæ™‚
        childTweet.classList.add('confirm');
        childTweet.style.background = 'rgba(255, 0, 0, 0.1)';
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        const handleDeleteKeypress = async (e) => {
          if (e.key === 'Enter') {
            // Enterã‚­ãƒ¼ã§å‰Šé™¤å®Ÿè¡Œ
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            
            try {
              // å­ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å‰Šé™¤
              tweetArray = await ipcRenderer.invoke('delete-child-tweet', parentIndex, childIndex);
              
              // ãƒ„ã‚¤ãƒ¼ãƒˆä¸€è¦§ã‚’å†æç”»
              refreshTweetDisplay(tweetArray);
            } catch (error) {
              console.error('Failed to delete child tweet:', error);
              childTweet.classList.remove('confirm');
              childTweet.style.background = '';
            }
          } else if (e.key === 'Escape') {
            // Escã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            childTweet.classList.remove('confirm');
            childTweet.style.background = '';
          }
        };
        
        document.addEventListener('keydown', handleDeleteKeypress);
        
        // ä»–ã®ãƒ„ã‚¤ãƒ¼ãƒˆãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const handleOtherFocus = (e) => {
          if (e.target.classList.contains('tweet') && e.target !== childTweet) {
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            childTweet.classList.remove('confirm');
            childTweet.style.background = '';
          }
        };
        
        document.addEventListener('focusin', handleOtherFocus);
      }
    }

    async function deleteTweet(index) {
      const focusedTweet = document.activeElement;
      if (!focusedTweet || !focusedTweet.classList.contains('tweet')) return;
      
      // data-actual-indexå±æ€§ã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
      if (isNaN(actualIndex)) {
        console.error('Invalid tweet index');
        return;
      }
      
      if (!focusedTweet.classList.contains('confirm')) {
        // æœ€åˆã®ç¢ºèªæ™‚
        focusedTweet.classList.add('confirm');
        focusedTweet.style.background = 'rgba(255, 0, 0, 0.1)';
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        const handleDeleteKeypress = async (e) => {
          if (e.key === 'Enter') {
            // Enterã‚­ãƒ¼ã§å‰Šé™¤å®Ÿè¡Œ
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            await executeDelete(actualIndex);
          } else if (e.key === 'Escape') {
            // Escã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            focusedTweet.classList.remove('confirm');
            focusedTweet.style.background = '';
          }
        };
        
        document.addEventListener('keydown', handleDeleteKeypress);
        
        // ä»–ã®ãƒ„ã‚¤ãƒ¼ãƒˆãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const handleOtherFocus = (e) => {
          if (e.target.classList.contains('tweet') && e.target !== focusedTweet) {
            document.removeEventListener('keydown', handleDeleteKeypress);
            document.removeEventListener('focusin', handleOtherFocus);
            focusedTweet.classList.remove('confirm');
            focusedTweet.style.background = '';
          }
        };
        
        document.addEventListener('focusin', handleOtherFocus);
        
        return;
      }
    }

    async function executeDelete(index) {
      try {
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆè¦ç´ ã‚’å–å¾—
        const focusedTweet = document.activeElement;
        if (!focusedTweet || !focusedTweet.classList.contains('tweet')) return;
        
        // data-actual-indexå±æ€§ã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
        
        if (isNaN(actualIndex)) {
          console.error('Invalid tweet index');
          return;
        }
        
        tweetArray = await ipcRenderer.invoke('delete-tweet', actualIndex);
        // ãƒ„ã‚¤ãƒ¼ãƒˆä¸€è¦§ã‚’å†æç”»
        refreshTweetDisplay(tweetArray);
      } catch (error) {
        console.error('Failed to delete tweet:', error);
      }
    }

    async function flushTweets() {
      showModal();
    }

    function showModal() {
      document.querySelector('.modal-overlay').style.display = 'block';
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('keydown', handleModalKeypress);
    }

    function hideModal() {
      document.querySelector('.modal-overlay').style.display = 'none';
      // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤ºæ™‚ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      document.removeEventListener('keydown', handleModalKeypress);
    }

    function handleModalKeypress(e) {
      if (e.key === 'Enter') {
        confirmFlush();
      } else if (e.key === 'Escape') {
        cancelFlush();
      }
    }

    async function confirmFlush() {
      hideModal();
      try {
        tweetArray = await ipcRenderer.invoke('flush-tweets');
        document.getElementById('tweets').innerHTML = '';
      } catch (error) {
        console.error('Failed to flush tweets:', error);
      }
    }

    function cancelFlush() {
      hideModal();
    }

    async function editTweet(index) {
      const focusedTweet = document.activeElement;
      if (!focusedTweet || !focusedTweet.classList.contains('tweet')) return;
      
      // data-actual-indexå±æ€§ã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
      if (isNaN(actualIndex)) {
        console.error('Invalid tweet index');
        return;
      }
      
      const contentSpan = focusedTweet.querySelector('.content');
      const originalContent = contentSpan.innerHTML.replace(/<br>/g, '\n');
      let isComposing = false;
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
      focusedTweet.classList.add('editing');
      contentSpan.contentEditable = true;
      contentSpan.textContent = originalContent;
      contentSpan.focus();

      // IMEå…¥åŠ›é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionStart = () => {
        isComposing = true;
      };

      // IMEå…¥åŠ›çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionEnd = () => {
        isComposing = false;
      };
      
      // ç·¨é›†å®Œäº†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const handleEditKeypress = async (e) => {
        // cmd + enterã§ä¿å­˜
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && !isComposing) {
          e.preventDefault();
          e.stopPropagation();
          const newContent = contentSpan.textContent.trim();

          if (newContent !== originalContent) {
            // ãƒ„ã‚¤ãƒ¼ãƒˆã®å†…å®¹ã‚’æ›´æ–°
            tweetArray[actualIndex].content = newContent.replace(/\n/g, '<br>');

            // ä¿å­˜
            try {
              await ipcRenderer.invoke('save-tweets', tweetArray);
              // è¡¨ç¤ºã‚’æ›´æ–°
              focusedTweet.setAttribute('data-text', newContent);
              contentSpan.innerHTML = newContent.replace(/\n/g, '<br>');
              contentSpan.contentEditable = false;
              focusedTweet.classList.remove('editing');
              focusedTweet.focus();
            } catch (error) {
              console.error('Failed to save edited tweet:', error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®å†…å®¹ã«æˆ»ã™
              contentSpan.innerHTML = originalContent;
              finishEditing();
            }
          } else {
            finishEditing();
          }
        } else if (e.key === 'Escape') {
          // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          e.preventDefault();
          e.stopPropagation();
          contentSpan.innerHTML = originalContent;
          finishEditing();
        }
      };

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®å…±é€šå‡¦ç†
      const finishEditing = () => {
        contentSpan.contentEditable = false;
        focusedTweet.classList.remove('editing');
        focusedTweet.focus();
        document.removeEventListener('keydown', handleEditKeypress);
        contentSpan.removeEventListener('compositionstart', handleCompositionStart);
        contentSpan.removeEventListener('compositionend', handleCompositionEnd);
      };
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('keydown', handleEditKeypress);
      contentSpan.addEventListener('compositionstart', handleCompositionStart);
      contentSpan.addEventListener('compositionend', handleCompositionEnd);
    }

    // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹å‡¦ç†
    function enterNewTweetEditMode(tweetElement) {
      const contentSpan = tweetElement.querySelector('.content');
      let isComposing = false;

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      if (contentSpan.textContent === 'Initialize thought sequence...') {
        contentSpan.textContent = '';
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
      tweetElement.classList.add('editing');
      contentSpan.contentEditable = true;
      contentSpan.focus();

      // IMEå…¥åŠ›é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionStart = () => {
        isComposing = true;
      };

      // IMEå…¥åŠ›çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      const handleCompositionEnd = () => {
        isComposing = false;
      };

      // ç·¨é›†å®Œäº†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const handleEditKeypress = async (e) => {
        // cmd + enterã§æŠ•ç¨¿
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && !isComposing) {
          e.preventDefault();
          e.stopPropagation();
          const newContent = contentSpan.textContent.trim();

          if (newContent) {
            try {
              // ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æŠ•ç¨¿
              await postTweet(newContent);
              // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
              contentSpan.textContent = '';
              contentSpan.focus();
            } catch (error) {
              console.error('Failed to post tweet:', error);
              showMessage('ãƒ„ã‚¤ãƒ¼ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } else {
            finishNewTweetEditing();
          }
        } else if (e.key === 'Escape') {
          // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          e.preventDefault();
          e.stopPropagation();
          contentSpan.textContent = 'Initialize thought sequence...';
          finishNewTweetEditing();
        } else if (e.key === 'Enter' && !e.metaKey && !e.ctrlKey) {
          // é€šå¸¸ã®Enterã‚­ãƒ¼ã¯æ”¹è¡Œã¨ã—ã¦å‡¦ç†
          e.stopPropagation();
        }
      };

      // æ–°è¦ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®å…±é€šå‡¦ç†
      const finishNewTweetEditing = () => {
        contentSpan.contentEditable = false;
        tweetElement.classList.remove('editing');
        tweetElement.focus();
        document.removeEventListener('keydown', handleEditKeypress);
        contentSpan.removeEventListener('compositionstart', handleCompositionStart);
        contentSpan.removeEventListener('compositionend', handleCompositionEnd);
      };

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('keydown', handleEditKeypress);
      contentSpan.addEventListener('compositionstart', handleCompositionStart);
      contentSpan.addEventListener('compositionend', handleCompositionEnd);
    }

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…
    let focusedTweetIndex = null;

    // ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®šã™ã‚‹é–¢æ•°
    function toggleFocusOnTweet() {
      const focusedTweet = document.activeElement;
      console.log('Active element:', focusedTweet);
      
      if (!focusedTweet || !focusedTweet.classList.contains('tweet') || focusedTweet.classList.contains('child-tweet')) {
        console.log('No valid tweet to focus');
        return;
      }
      
      // data-actual-indexå±æ€§ã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const actualIndex = parseInt(focusedTweet.getAttribute('data-actual-index'));
      if (isNaN(actualIndex)) {
        console.error('Invalid tweet index');
        return;
      }
      
      console.log('Toggle focus on tweet with index:', actualIndex);
      console.log('Current focused tweet index:', focusedTweetIndex);
      
      // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ç¢ºèª
      if (focusedTweetIndex === actualIndex) {
        // åŒã˜ãƒ„ã‚¤ãƒ¼ãƒˆãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è§£é™¤
        console.log('Removing focus');
        focusedTweetIndex = null;
        
        // ã™ã¹ã¦ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        const focusedElements = document.querySelectorAll('.tweet.focused');
        console.log('Found focused elements to remove:', focusedElements.length);
        
        focusedElements.forEach(tweet => {
          tweet.classList.remove('focused');
          console.log('Removed focused class from tweet');
          
          const focusIndicator = tweet.querySelector('.focus-indicator');
          if (focusIndicator) {
            focusIndicator.remove();
            console.log('Removed focus indicator');
          }
        });
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ä¿å­˜
        try {
          localStorage.removeItem('focusedTweetIndex');
          console.log('Focus state removed from localStorage');
        } catch (e) {
          console.error('Error removing focus state from localStorage:', e);
        }
      } else {
        // æ–°ã—ã„ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        console.log('Setting new focus');
        
        // ä»¥å‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è§£é™¤
        const previousFocused = document.querySelectorAll('.tweet.focused');
        console.log('Found previously focused elements:', previousFocused.length);
        
        previousFocused.forEach(tweet => {
          tweet.classList.remove('focused');
          console.log('Removed focused class from previous tweet');
          
          const focusIndicator = tweet.querySelector('.focus-indicator');
          if (focusIndicator) {
            focusIndicator.remove();
            console.log('Removed previous focus indicator');
          }
        });
        
        // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
        focusedTweetIndex = actualIndex;
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        focusedTweet.classList.add('focused');
        console.log('Added focused class to new tweet');
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¿½åŠ 
        const contentElement = focusedTweet.querySelector('.content');
        if (contentElement) {
          const focusIndicator = document.createElement('span');
          focusIndicator.className = 'focus-indicator';
          focusIndicator.innerHTML = 'â˜…';
          contentElement.insertBefore(focusIndicator, contentElement.firstChild);
          console.log('Added focus indicator to new tweet');
        } else {
          console.log('Content element not found in tweet');
        }
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ä¿å­˜
        try {
          localStorage.setItem('focusedTweetIndex', actualIndex.toString());
          console.log('Focus state saved as:', actualIndex.toString());
        } catch (e) {
          console.error('Error saving focus state to localStorage:', e);
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('After toggle, focused tweet index:', focusedTweetIndex);
        console.log('Focused elements:', document.querySelectorAll('.tweet.focused').length);
        console.log('Focus indicators:', document.querySelectorAll('.focus-indicator').length);
      }
    }

    // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
    function restoreFocusState() {
      let savedFocusIndex = null;
      
      try {
        savedFocusIndex = localStorage.getItem('focusedTweetIndex');
        console.log('Restoring focus state, saved index:', savedFocusIndex);
      } catch (e) {
        console.error('Error reading focus state from localStorage:', e);
        return;
      }
      
      if (savedFocusIndex && savedFocusIndex !== 'null') {
        const parsedIndex = parseInt(savedFocusIndex, 10);
        if (isNaN(parsedIndex)) {
          console.log('Invalid saved focus index:', savedFocusIndex);
          return;
        }
        
        focusedTweetIndex = parsedIndex;
        console.log('Parsed focus index:', focusedTweetIndex);
        
        // å°‘ã—é…å»¶ã•ã›ã¦DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
        setTimeout(() => {
          const tweetToFocus = document.querySelector(`.tweet[data-actual-index="${focusedTweetIndex}"]:not(.child-tweet)`);
          console.log('Tweet to focus:', tweetToFocus);
          
          if (tweetToFocus) {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            tweetToFocus.classList.add('focused');
            console.log('Added focused class to tweet');
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const contentElement = tweetToFocus.querySelector('.content');
            if (contentElement) {
              // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãŒã‚ã‚Œã°å‰Šé™¤
              const existingIndicator = contentElement.querySelector('.focus-indicator');
              if (existingIndicator) {
                existingIndicator.remove();
                console.log('Removed existing focus indicator');
              }
              
              const focusIndicator = document.createElement('span');
              focusIndicator.className = 'focus-indicator';
              focusIndicator.innerHTML = 'â˜…';
              contentElement.insertBefore(focusIndicator, contentElement.firstChild);
              console.log('Added focus indicator to tweet content');
            }
            
            console.log('Focus applied to element');
          } else {
            console.log('Tweet to focus not found');
            // ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            focusedTweetIndex = null;
            try {
              localStorage.removeItem('focusedTweetIndex');
              console.log('Focus state removed from localStorage (tweet not found)');
            } catch (e) {
              console.error('Error removing focus state from localStorage:', e);
            }
          }
        }, 200); // é…å»¶ã‚’200ãƒŸãƒªç§’ã«çŸ­ç¸®
      } else {
        console.log('No focus to restore');
        focusedTweetIndex = null;
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener('DOMContentLoaded', () => {
      // ... existing code ...
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('focusBtn').addEventListener('click', () => {
        console.log('Focus button clicked');
        // ç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆãŒãªã„å ´åˆã¯ã€æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
        const currentFocus = document.activeElement;
        if (!currentFocus || !currentFocus.classList.contains('tweet') || currentFocus.classList.contains('child-tweet') || currentFocus.classList.contains('new-tweet')) {
          const firstTweet = document.querySelector('.tweet:not(.child-tweet):not(.new-tweet)');
          if (firstTweet) {
            firstTweet.focus();
          }
        }
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ©Ÿèƒ½ã‚’å®Ÿè¡Œ
        toggleFocusOnTweet();
      });
      
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è¿½åŠ 
      document.addEventListener('keydown', (e) => {
        // ... existing code ...
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ©Ÿèƒ½ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ (f)
        if (e.key === 'f' && !e.ctrlKey && !e.metaKey && !e.altKey && !isEditing()) {
          e.preventDefault();
          toggleFocusOnTweet();
        }
      });
      
      // åˆæœŸè¡¨ç¤ºæ™‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒ
      restoreFocusState();
    });
  </script>
</body>
</html>
